<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Росатом чатбот</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/chatbot.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body onload="bodyOnLoad()">

  <section class="msger">
    <header class="msger-header">
      <div class="menu-icon">
	    <ul class="menu-icons" onclick="showMenu()">
	      <li></li>
	      <li></li>
	      <li></li>
        </ul>
	  </div>
      <div class="msger-header-title"><b>Росатом чатбот</b></div>
<!--      <div class="dropdown">-->
<!--	    <ul class="icons" onclick="showDropdown()">-->
<!--	      <li></li>-->
<!--	      <li></li>-->
<!--	      <li></li>-->
<!--        </ul>-->
<!--	    <div id="dropdown-list" class="dropdown-content">-->
<!--		  <a onclick="clearChat()">Очистить чат</a>-->
<!--		  <a onclick="logout()">Выйти</a>-->
<!--	    </div>-->
<!--	  </div>-->
    </header>
    <div class="msger-body">
	  <menu class="menu menu-element">
		<div id="menu-list" class="menu-content menu-element">
		  <div class="menu-list-item menu-content-top menu-element">
			<div class="user-info user-avatar menu-element">
			</div>
			  <div class="user-info user-fio menu-element">
			    <div class="user-info user-surname menu-element"></div>
			    <div class="user-info user-name menu-element"></div>
			    <div class="user-info user-patronymic menu-element"></div>
			    <div class="user-info user-department menu-element"></div>
			    <div class="user-info user-experience menu-element"></div>
			  </div>
		    </div>
		  <div class="menu-list-item menu-content-middle menu-element">
			<div class="menu-content-middle-top menu-element">
			  <a onclick="chatbot()">Чатбот</a>
			  <a onclick="quests()">Квесты</a>
			  <a onclick="meetings()">Встречи</a>
			  <a onclick="jobs()">Дела</a>
			</div>
			<div class="menu-content-middle-bottom menu-element">
			  <a onclick="logout()">Выйти</a>
			</div>
		  </div>
		  <div class="menu-list-item menu-content-bottom menu-element">
		    <div class="app-version menu-element"></div>
		  </div>
	    </div>
	  </menu>
	  <div class="main"></div>
    </div>
  </section>

  <script>

    const BOT_IMG = "{{ url_for('static', filename='images/logo.png') }}";
    const PERSON_IMG = "{{ url_for('static', filename='images/logo2.png') }}";
    const BOT_NAME = "Атом";
    const PERSON_NAME = "Ты";

    function bodyOnLoad() {
      getchatbot();
      $.get("/getuserdata").done(function (data) {
        let userData = JSON.parse(data);
        $('.user-surname').text(userData.surname);
        $('.user-name').text(userData.name);
        $('.user-patronymic').text(userData.patronymic);
        $('.user-department').text(userData.department);
        $('.user-experience').text(userData.experience);
        document.getElementsByClassName("user-avatar")[0].style.backgroundImage = userData.photo;
        $('.app-version').text(userData.version);
      });
    }

    function chatbot() {
      if(! $('.main').hasClass('msger-chat-form'))
      	getchatbot();
	}

    function getchatbot() {
      $.get("/getchatbot").done(function (data) {
        $('.main').html(data);
        $('.main').removeClass('msger-quests-form msger-meetings-form msger-jobs-form').addClass('msger-chat-form');

        let msgerForm = get(".msger-inputarea");

        msgerForm.addEventListener("submit", event => {
	      event.preventDefault();
	      let msgerInput = get(".msger-input");
	      let msgText = msgerInput.value;
		  if (!msgText) return;
		  appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
		  msgerInput.value = "";
		  botResponse(msgText);
		});
	  });
      $.get("/getfirstmessage").done(function (data) {
        let msgText = data;
        appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
      });
	}

	function quests() {
      if(! $('.main').hasClass('msger-quests-form'))
      	getquests();
	}

    function getquests() {
      $.get("/getquests").done(function (data) {
      	 $('.main').html(data);
      	 $('.main').removeClass('msger-chat-form msger-meetings-form msger-jobs-form').addClass('msger-quests-form');
	  });
	}

	function meetings() {
      if(! $('.main').hasClass('msger-meetings-form'))
      	getmeetings();
	}

    function getmeetings() {
      $.get("/getmeetings").done(function (data) {
      	 $('.main').html(data);
      	 $('.main').removeClass('msger-chat-form msger-quests-form msger-jobs-form').addClass('msger-meetings-form');
	  });
	}

	function jobs() {
      if(! $('.main').hasClass('msger-jobs-form'))
      	getjobs();
	}

    function getjobs() {
      $.get("/getjobs").done(function (data) {
      	 $('.main').html(data);
      	 $('.main').removeClass('msger-chat-form msger-quests-form msger-meetings-form').addClass('msger-jobs-form');
	  });
	}

    window.onclick = function(event) {
	  // if (!event.target.matches('.icons')) {
		// let dropdowns = document.getElementsByClassName("dropdown-content");
		// for (let i = 0; i < dropdowns.length; i++)
		//   if (dropdowns[i].classList.contains('show'))
		// 	dropdowns[i].classList.remove('show');
	  // }
	  if (!event.target.matches('.menu-icons') && !event.target.matches('.menu-element')) {
		let menu = document.getElementsByClassName("menu-content");
		for (let i = 0; i < menu.length; i++)
		  if (menu[i].classList.contains('show-menu'))
			menu[i].classList.remove('show-menu');
	  }
	}

	// function showDropdown() {
	//   document.getElementById("dropdown-list").classList.toggle("show");
	// }

	function showMenu() {
	  document.getElementById("menu-list").classList.toggle("show-menu");
	}

	function imgOnClick(img) {
	  if (img.classList.contains("popup")){
		img.classList.remove("popup");
		img.getElementsByTagName("img")[0].classList.remove("full-img");
	  }
	  else {
		img.classList.add("popup");
		img.getElementsByTagName("img")[0].classList.add("full-img");
	  }
	}

	// function clearChat() {
	//   let elms = document.getElementsByClassName("msg");
	//   while (elms.length > 1)
	// 	  elms[1].remove();
	// }

	function logout() {
	  $.get("/logout").done(function () {
	    location.reload();
      })
	}

    function botResponse(rawText) {
      $.get("/getresponse", { msg: rawText }).done(function (data) {
        let msgText = data;
        appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
      });
    }

    function cmdOnClick(msgText) {
		appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText, "");
        botResponse(msgText);
	}

    function get(selector, root = document) {
      return root.querySelector(selector);
    }

    function formatDate(date) {
      let h = "0" + date.getHours();
      let m = "0" + date.getMinutes();
      return `${h.slice(-2)}:${m.slice(-2)}`;
    }

    function appendMessage(name, img, side, text) {
      let personImg = img;
      let personName = name;
	  if (side == "right") {
	  	if (!(String(document.getElementsByClassName("user-avatar")[0].style.backgroundImage).indexOf("nophoto") + 1)) {
	  	  personImg = document.getElementsByClassName("user-avatar")[0].style.backgroundImage;
		  personImg = personImg.slice(5, -1);
		}
		personName = document.getElementsByClassName("user-name")[0].innerText;
	  }
      let msgHTML = `
        <div class="msg ${side}-msg">
          <div class="msg-img" style="background-image: url(${personImg})"></div>

          <div class="msg-bubble">
            <div class="msg-info">
              <div class="msg-info-name">${personName}</div>
              <div class="msg-info-time">${formatDate(new Date())}</div>
            </div>

            <div class="msg-text">${text}</div>
          </div>
        </div>
      `;
	  let msgerChat = get(".msger-chat");
      msgerChat.insertAdjacentHTML("beforeend", msgHTML);
      msgerChat.scrollTop = msgerChat.scrollHeight;
    }

  </script>

</body>

</html>