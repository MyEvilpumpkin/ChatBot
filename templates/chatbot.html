<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Росатом чатбот</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/chatbot.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body onload="bodyonload()">

  <section class="msger">

    <header class="msger-header">
      <div class="msger-header-title"><b>Росатом чатбот</b></div>
      <div class="dropdown">
	    <ul class="icons" onclick="showDropdown()">
	      <li></li>
	      <li></li>
	      <li></li>
        </ul>
	    <div id="dropdown-list" class="dropdown-content">
		  <a onclick="clearChat()">Очистить чат</a>
		  <a onclick="logout()">Выйти</a>
	    </div>
	  </div>
    </header>

    <main class="msger-chat" style="background-image: url({{ url_for('static', filename='images/background.png') }})"></main>

    <form class="msger-inputarea">
      <input type="text" class="msger-input" id="textInput" placeholder="Напиши свой вопрос..." autocomplete="off">
      <button type="submit" class="msger-send-btn">Отправить</button>
    </form>

  </section>

  <script>

    const msgerForm = get(".msger-inputarea");
    const msgerInput = get(".msger-input");
    const msgerChat = get(".msger-chat");

    const BOT_IMG = "{{ url_for('static', filename='images/logo.png') }}";
    const PERSON_IMG = "{{ url_for('static', filename='images/logo2.png') }}";
    const BOT_NAME = "Атом";
    const PERSON_NAME = "Ты";

    msgerForm.addEventListener("submit", event => {
      event.preventDefault();
      const msgText = msgerInput.value;
      if (!msgText) return;
      appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
      msgerInput.value = "";
      botResponse(msgText);
    });

    function showDropdown() {
	  document.getElementById("dropdown-list").classList.toggle("show");
	}

	window.onclick = function(event) {
	  if (!event.target.matches('.icons')) {
		let dropdowns = document.getElementsByClassName("dropdown-content");
		for (let i = 0; i < dropdowns.length; i++)
		  if (dropdowns[i].classList.contains('show'))
			dropdowns[i].classList.remove('show');
	  }
	}

	function imgOnClick(img) {
	  if (img.classList.contains("popup")){
		img.classList.remove("popup");
		img.getElementsByTagName("img")[0].classList.remove("full-img");
	  }
	  else {
		img.classList.add("popup");
		img.getElementsByTagName("img")[0].classList.add("full-img");
	  }
	}

	function clearChat() {
	  let elms = document.getElementsByClassName("msg");
	  while (elms.length > 1)
		  elms[1].remove();
	}

	function logout() {
	  $.get("/logout").done(function () {
	    location.reload();
      })
	}

    function bodyonload() {
		$.get("/getfirstmessage").done(function (data) {
        console.log(data);
        const msgText = data;
        appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
      });
	}

    function botResponse(rawText) {
      $.get("/getresponse", { msg: rawText }).done(function (data) {
        console.log(rawText);
        console.log(data);
        const msgText = data;
        appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
      });
    }

    function cmdOnClick(msgText) {
		appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText, "");
        botResponse(msgText);
	}

    function get(selector, root = document) {
      return root.querySelector(selector);
    }

    function formatDate(date) {
      const h = "0" + date.getHours();
      const m = "0" + date.getMinutes();
      return `${h.slice(-2)}:${m.slice(-2)}`;
    }

    function appendMessage(name, img, side, text) {
      const msgHTML = `
        <div class="msg ${side}-msg">
          <div class="msg-img" style="background-image: url(${img})"></div>

          <div class="msg-bubble">
            <div class="msg-info">
              <div class="msg-info-name">${name}</div>
              <div class="msg-info-time">${formatDate(new Date())}</div>
            </div>

            <div class="msg-text">${text}</div>
          </div>
        </div>
      `;

      msgerChat.insertAdjacentHTML("beforeend", msgHTML);
      msgerChat.scrollTop += 500;
    }

  </script>

</body>

</html>